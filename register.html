<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    .choices__inner {
      border-radius: 0.5rem !important;
      border-color: #d1d5db !important;
      min-height: 44px;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
  <h2 class="text-2xl font-bold mb-4 text-center">
    Bedridden Patient Registration
  </h2>

  <form id="regForm" class="space-y-3" onsubmit="event.preventDefault(); registerPatient();">

    <input id="national_id" required
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="National ID *">

    <input id="full_name" required
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Full Name *">

    <input type="date" id="dob"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">

    <select id="sex"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">
      <option value="">Select Sex</option>
      <option>Male</option>
      <option>Female</option>
    </select>

    <textarea id="address"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Address"></textarea>

    <input id="island"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Island">

    <input type="tel" id="contact"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Contact Number">

    <input id="caregiver_name"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Caregiver Name">

    <input type="tel" id="caregiver_contact"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Caregiver Contact">

    <textarea id="remarks"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Remarks"></textarea>

    <!-- Registered By -->
    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide">
      Registered By
    </label>
    <select id="registered_by" required>
      <option value="">Loading staff...</option>
    </select>

    <button type="submit"
      class="bg-blue-600 text-white py-2 px-4 rounded w-full hover:bg-blue-700 transition">
      Register Patient
    </button>

    <p id="status" class="text-center text-sm mt-2"></p>
  </form>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxmcWZi7YlMySKKbBhKkhUh3Ynj1LuVMV0o7YlgcTCrp8AA4pDypJs4XZWWi2dLn7Mq/exec";
const STAFF_API_URL = "https://script.google.com/macros/s/AKfycbyaBLAkJtS1lH0uJXZxmpLoHwb6kM51lQWyMuLlvDGXIdfovZhl8ag3MnMDL_aeq-oGmA/exec";
const HCF_FILTER = "SHAH-PHU";

let staffChoices;

/* Load staff list */
async function loadStaff() {
  const select = document.getElementById("registered_by");

  try {
    const res = await fetch(STAFF_API_URL);
    const data = await res.json();
    const filtered = data.filter(s => s.Hcf === HCF_FILTER);

    let html = '<option value="">Select Staff</option>';
    filtered.forEach(s => {
      const name = s["Staff Name and Designation"];
      html += `<option value="${name}">${name}</option>`;
    });
    html += '<option value="not_in_list">+ Register New</option>';

    select.innerHTML = html;

    staffChoices = new Choices(select, {
      searchEnabled: true,
      shouldSort: false,
      itemSelectText: ''
    });

    select.addEventListener("change", () => {
      if (select.value === "not_in_list") {
        window.open(
          `https://shaviyanipublichealth.blogspot.com/p/register-new.html?hcf=${encodeURIComponent(HCF_FILTER)}`,
          "Register",
          "width=800,height=600"
        );
        staffChoices.setChoiceByValue("");
      }
    });

  } catch {
    select.innerHTML = '<option value="">Error loading staff</option>';
  }
}

/* Register patient */
function registerPatient() {
  const payload = {
    action: "registerPatient",
    national_id: national_id.value.trim(),
    full_name: full_name.value.trim(),
    dob: dob.value,
    sex: sex.value,
    address: address.value,
    island: island.value,
    contact: contact.value,
    caregiver_name: caregiver_name.value,
    caregiver_contact: caregiver_contact.value,
    remarks: remarks.value,
    registered_by: registered_by.value
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    if (res.status === "exists") {
      status.textContent = "⚠ Patient already registered";
      status.className = "text-red-600 text-center text-sm";
      return;
    }

    status.textContent = "✅ Patient registered successfully";
    status.className = "text-green-600 text-center text-sm";
    regForm.reset();
    staffChoices.removeActiveItems();

    setTimeout(() => location.href = "index.html", 1500);
  })
  .catch(() => {
    status.textContent = "❌ Network error";
    status.className = "text-red-600 text-center text-sm";
  });
}

/* Init */
loadStaff();
</script>

</body>
</html>
