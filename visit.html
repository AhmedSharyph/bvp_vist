<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Visit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

<div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
  <h2 class="text-2xl font-bold mb-4 text-center">Patient Visit</h2>

  <form id="visitForm" class="space-y-3" onsubmit="event.preventDefault(); saveVisit();">

    <select class="input-field" id="patient" required>
      <option value="">Select Patient</option>
    </select>

    <select class="input-field" id="visit_type" required>
      <option>Nurse Visit</option>
      <option>Doctor Visit</option>
      <option>Non-Routine Visit</option>
    </select>

    <textarea class="input-field" id="findings" placeholder="Findings"></textarea>
    <textarea class="input-field" id="actions_taken" placeholder="Actions Taken"></textarea>
    <input class="input-field" type="date" id="next_visit_date" placeholder="Next Visit Date">
    <input class="input-field" type="text" id="entered_by" placeholder="Staff Name">

    <button class="bg-green-600 text-white py-2 px-4 rounded w-full hover:bg-green-700 transition" type="submit">
      Save Visit
    </button>

    <p id="status" class="text-center mt-2 text-sm"></p>
  </form>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz_TizFmrdtTFslZdHydEaBXhqOkANnNH-NKBWISnlbeCMvZyRecjeCl1wXZpqQYOu1/exec";

// Load patients dropdown
function loadPatients() {
  fetch(GAS_URL + "?action=getPatients")
    .then(r => r.json())
    .then(data => {
      data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.national_id;
        opt.text = p.full_name + " (" + p.national_id + ")";
        patient.appendChild(opt);
      });
    })
    .catch(() => status.innerText = "⚠ Could not load patients.");
}

function saveVisit() {
  const payload = {
    action: "addVisit",
    national_id: patient.value,
    visit_type: visit_type.value,
    findings: findings.value,
    actions_taken: actions_taken.value,
    next_visit_date: next_visit_date.value,
    entered_by: entered_by.value
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(() => {
    status.innerText = "✅ Visit saved successfully!";
    status.classList.add("text-green-500");

    // Reset form
    document.getElementById("visitForm").reset();

    // Optional: redirect to home after 1.5s
    setTimeout(() => window.location.href = "index.html", 1500);
  })
  .catch(() => {
    status.innerText = "❌ Network error. Data not sent.";
    status.classList.add("text-red-500");
  });
}

// Initialize
loadPatients();
</script>

<style>
.input-field {
  @apply w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400;
}
</style>

</body>
</html>
