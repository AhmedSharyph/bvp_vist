<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Visit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Choices.js -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <style>
    .choices__inner {
      border-radius: 0.5rem !important;
      border-color: #d1d5db !important;
      min-height: 44px;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
  <h2 class="text-2xl font-bold mb-4 text-center">Patient Visit</h2>

  <form id="visitForm" class="space-y-3" onsubmit="event.preventDefault(); saveVisit();">

    <!-- Patient -->
    <select id="patient" required
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">
      <option value="">Select Patient</option>
    </select>

    <!-- Visit Type -->
    <select id="visit_type" required
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">
      <option>Nurse Visit</option>
      <option>Doctor Visit</option>
      <option>Non-Routine Visit</option>
    </select>

    <!-- Findings -->
    <textarea id="findings" rows="3"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Findings"></textarea>

    <!-- Actions -->
    <textarea id="actions_taken" rows="3"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400"
      placeholder="Actions Taken"></textarea>

    <!-- Next Visit -->
    <input type="date" id="next_visit_date"
      class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-400">

    <!-- Entered By -->
    <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide">
      Entered By
    </label>
    <select id="entered_by" required>
      <option value="">Loading staff...</option>
    </select>

    <!-- Submit -->
    <button type="submit"
      class="bg-green-600 text-white py-2 px-4 rounded w-full hover:bg-green-700 transition">
      Save Visit
    </button>

    <p id="status" class="text-center text-sm mt-2"></p>
  </form>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz_TizFmrdtTFslZdHydEaBXhqOkANnNH-NKBWISnlbeCMvZyRecjeCl1wXZpqQYOu1/exec";
const STAFF_API_URL = "https://script.google.com/macros/s/AKfycbyaBLAkJtS1lH0uJXZxmpLoHwb6kM51lQWyMuLlvDGXIdfovZhl8ag3MnMDL_aeq-oGmA/exec";
const HCF_FILTER = "SHAH-PHU";

let staffChoices;

/* Load patients */
function loadPatients() {
  fetch(GAS_URL + "?action=getPatients")
    .then(r => r.json())
    .then(data => {
      data.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.national_id;
        opt.textContent = `${p.full_name} (${p.national_id})`;
        patient.appendChild(opt);
      });
    })
    .catch(() => status.textContent = "⚠ Could not load patients");
}

/* Load staff */
async function loadStaff() {
  const select = document.getElementById("entered_by");
  const res = await fetch(STAFF_API_URL);
  const data = await res.json();

  const filtered = data.filter(s => s.Hcf === HCF_FILTER);

  let html = '<option value="">Select Staff</option>';
  filtered.forEach(s => {
    const name = s["Staff Name and Designation"];
    html += `<option value="${name}">${name}</option>`;
  });
  html += '<option value="not_in_list">+ Register New</option>';

  select.innerHTML = html;

  staffChoices = new Choices(select, {
    searchEnabled: true,
    shouldSort: false,
    itemSelectText: ''
  });

  select.addEventListener("change", () => {
    if (select.value === "not_in_list") {
      window.open(
        `https://shaviyanipublichealth.blogspot.com/p/register-new.html?hcf=${encodeURIComponent(HCF_FILTER)}`,
        "Register",
        "width=800,height=600"
      );
      staffChoices.setChoiceByValue("");
    }
  });
}

/* Save visit */
function saveVisit() {
  const payload = {
    action: "addVisit",
    national_id: patient.value,
    visit_type: visit_type.value,
    findings: findings.value,
    actions_taken: actions_taken.value,
    next_visit_date: next_visit_date.value,
    entered_by: entered_by.value
  };

  fetch(GAS_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(() => {
    status.textContent = "✅ Visit saved successfully";
    status.className = "text-green-600 text-center text-sm";
    visitForm.reset();
    staffChoices.removeActiveItems();
    setTimeout(() => location.href = "index.html", 1500);
  })
  .catch(() => {
    status.textContent = "❌ Network error";
    status.className = "text-red-600 text-center text-sm";
  });
}

/* Init */
loadPatients();
loadStaff();
</script>

</body>
</html>
