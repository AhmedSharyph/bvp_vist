<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bedridden Patient App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Choices.js for searchable dropdown -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10">

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="w-full max-w-md bg-white p-6 rounded-lg shadow-lg">
  <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
  <input type="email" id="email" placeholder="Enter your email" class="w-full p-2 border border-gray-300 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-400">
  <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition" onclick="login()">Login</button>
  <p id="loginStatus" class="mt-2 text-center text-sm text-red-500"></p>
</div>

<!-- APP SCREEN -->
<div id="appScreen" class="hidden w-full max-w-3xl space-y-6">

  <p id="welcome" class="text-center font-semibold text-lg"></p>

  <!-- REGISTRATION FORM (admin only) -->
  <div id="regFormContainer" class="bg-white p-6 rounded-lg shadow-lg hidden">
    <h2 class="text-xl font-bold mb-4 text-center">Register Patient</h2>
    <form id="regForm" class="space-y-3" onsubmit="event.preventDefault(); registerPatient();">
      <input class="input-field" type="text" id="national_id" placeholder="National ID *" required>
      <input class="input-field" type="text" id="full_name" placeholder="Full Name *" required>
      <input class="input-field" type="date" id="dob" placeholder="Date of Birth">
      <select class="input-field" id="sex">
        <option value="">Select Sex</option>
        <option>Male</option>
        <option>Female</option>
      </select>
      <textarea class="input-field" id="address" placeholder="Address"></textarea>
      <input class="input-field" type="text" id="island" placeholder="Island">
      <input class="input-field" type="tel" id="contact" placeholder="Contact Number">
      <input class="input-field" type="text" id="caregiver_name" placeholder="Caregiver Name">
      <input class="input-field" type="tel" id="caregiver_contact" placeholder="Caregiver Contact">
      <textarea class="input-field" id="remarks" placeholder="Remarks"></textarea>

      <button class="bg-green-600 text-white py-2 px-4 rounded w-full hover:bg-green-700 transition" type="submit">Register Patient</button>
      <p id="regStatus" class="text-center mt-2 text-sm"></p>
    </form>
  </div>

  <!-- VISIT FORM (all roles) -->
  <div id="visitFormContainer" class="bg-white p-6 rounded-lg shadow-lg">
    <h2 class="text-xl font-bold mb-4 text-center">Patient Visit</h2>
    <form id="visitForm" class="space-y-3" onsubmit="event.preventDefault(); saveVisit();">
      <select class="input-field" id="patient" required></select>
      <select class="input-field" id="visit_type" required>
        <option>Nurse Visit</option>
        <option>Doctor Visit</option>
        <option>Non-Routine Visit</option>
      </select>
      <textarea class="input-field" id="findings" placeholder="Findings"></textarea>
      <textarea class="input-field" id="actions_taken" placeholder="Actions Taken"></textarea>
      <input class="input-field" type="date" id="next_visit_date" placeholder="Next Visit Date">
      <button class="bg-blue-600 text-white py-2 px-4 rounded w-full hover:bg-blue-700 transition" type="submit">Save Visit</button>
      <p id="visitStatus" class="text-center mt-2 text-sm"></p>
    </form>
  </div>

  <div class="text-center mt-4">
    <button onclick="logout()" class="text-red-600 hover:underline">Logout</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_ID/exec";
let currentUser = null;
let patientChoices = null;
let db;

// IndexedDB
function initDB() {
  const request = indexedDB.open("BedriddenVisitsDB", 1);
  request.onupgradeneeded = e => {
    db = e.target.result;
    if (!db.objectStoreNames.contains("visits")) {
      db.createObjectStore("visits", { keyPath: "id", autoIncrement: true });
    }
  };
  request.onsuccess = e => { db = e.target.result; syncOfflineVisits(); };
  request.onerror = e => console.error("IndexedDB error", e);
}

// LOGIN
async function login() {
  const email = document.getElementById("email").value.trim().toLowerCase();
  if (!email) {
    loginStatus.innerText = "Please enter your email";
    return;
  }

  try {
    const res = await fetch(`${API_URL}?action=getUser`);
    const data = await res.json();

    if (!data || data.email?.toLowerCase() !== email || data.active.toUpperCase() !== "YES") {
      loginStatus.innerText = "Access denied or inactive user";
      return;
    }

    currentUser = data;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("appScreen").classList.remove("hidden");
    document.getElementById("welcome").innerText = `Welcome, ${data.email} (${data.role})`;

    if (data.role === "admin") document.getElementById("regFormContainer").classList.remove("hidden");
    await loadPatients();
    initDB();
  } catch (err) {
    loginStatus.innerText = "Error connecting to server";
    console.error(err);
  }
}

// LOGOUT
function logout() { location.reload(); }

// LOAD PATIENTS
async function loadPatients() {
  try {
    const res = await fetch(`${API_URL}?action=getPatients`);
    const data = await res.json();
    const sel = document.getElementById("patient");
    sel.innerHTML = '<option value="">Select Patient</option>';
    data.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.national_id;
      opt.text = `${p.full_name} (${p.national_id})`;
      sel.appendChild(opt);
    });
    if (patientChoices) patientChoices.destroy();
    patientChoices = new Choices(sel, { searchEnabled: true, itemSelectText: '' });
  } catch (err) { console.error(err); }
}

// REGISTER PATIENT
async function registerPatient() {
  const payload = {
    action: "registerPatient",
    national_id: national_id.value.trim(),
    full_name: full_name.value.trim(),
    dob: dob.value,
    sex: sex.value,
    address: address.value,
    island: island.value,
    contact: contact.value,
    caregiver_name: caregiver_name.value,
    caregiver_contact: caregiver_contact.value,
    remarks: remarks.value
  };
  try {
    const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    const data = await res.json();
    if (data.status === "exists") { regStatus.innerText = "⚠ Patient already registered"; return; }
    regStatus.innerText = "✅ Patient registered successfully!";
    regForm.reset();
    await loadPatients();
  } catch (err) { regStatus.innerText = "❌ Network error"; console.error(err); }
}

// SAVE VISIT
async function saveVisit() {
  const payload = {
    action: "addVisit",
    national_id: patient.value,
    visit_type: visit_type.value,
    findings: findings.value,
    actions_taken: actions_taken.value,
    next_visit_date: next_visit_date.value
  };

  if (navigator.onLine) {
    try {
      const res = await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
      const data = await res.json();
      visitStatus.innerText = "✅ Visit saved successfully!";
      visitForm.reset();
    } catch (err) {
      visitStatus.innerText = "❌ Network error";
      saveVisitOffline(payload);
    }
  } else {
    saveVisitOffline(payload);
  }
}

// OFFLINE SAVE
function saveVisitOffline(payload) {
  const tx = db.transaction("visits", "readwrite");
  tx.objectStore("visits").add({ ...payload, timestamp: new Date().toISOString() });
  visitStatus.innerText = "⚠ Offline: Visit saved locally. Will sync later.";
  visitForm.reset();
}

// SYNC OFFLINE
function syncOfflineVisits() {
  const tx = db.transaction("visits", "readonly");
  const store = tx.objectStore("visits");
  store.getAll().onsuccess = async e => {
    const visits = e.target.result;
    for (const v of visits) {
      try {
        await fetch(API_URL, { method: "POST", body: JSON.stringify(v) });
        const txDel = db.transaction("visits", "readwrite");
        txDel.objectStore("visits").delete(v.id);
      } catch (err) { console.warn("Failed to sync visit", v); }
    }
  };
}

// SYNC WHEN ONLINE
window.addEventListener("online", syncOfflineVisits);
</script>

<style>
.input-field { @apply w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400; }
</style>

</body>
</html>
